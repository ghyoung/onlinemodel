# 校验脚本使用说明

**版本**: v1.0.0  
**更新日期**: 2024-08-15  
**作者**: 开发团队  

## 目录
- [概述](#概述)
- [脚本位置](#脚本位置)
- [脚本功能说明](#脚本功能说明)
- [使用方法](#使用方法)
- [输出示例](#输出示例)
- [故障排除](#故障排除)
- [相关文档](#相关文档)

## 概述

本项目的校验脚本用于确保系统的一致性，包括数据库结构、前后端接口、文件完整性等。这些脚本是开发质量保证的重要工具。

## 脚本位置

所有校验脚本都位于 `code/init-scripts/` 目录下：

```
code/init-scripts/
├── fix-database.js          # 数据库修复脚本
├── quick-validate.js        # 快速校验脚本
├── validate-system.js       # 完整系统校验脚本
├── package.json             # 依赖配置
└── 其他脚本文件...
```

## 脚本功能说明

### 1. fix-database.js
**功能**: 修复数据库表结构不一致问题
- 检查缺失的字段
- 自动添加必需的字段
- 验证修复结果

**适用场景**: 
- 数据库结构错误
- 字段缺失问题
- 表结构不完整

### 2. quick-validate.js
**功能**: 快速系统校验
- 数据库连接检查
- 核心表访问验证
- 关键字段存在性检查

**适用场景**:
- 日常开发检查
- 快速问题排查
- 启动前验证

### 3. validate-system.js
**功能**: 完整系统校验
- 数据库表结构详细检查
- 后端API文件完整性
- 前端组件完整性
- 环境配置检查
- 生成详细报告

**适用场景**:
- 功能开发完成后
- 部署前检查
- 问题深度排查

## 使用方法

### 前置条件
确保已安装必要的依赖：
```bash
cd code/init-scripts
npm install
```

### 直接运行脚本
```bash
# 数据库修复
node fix-database.js

# 快速校验
node quick-validate.js

# 完整校验
node validate-system.js
```

### 通过启动脚本运行
```bash
# 快速校验
./start-dev.sh quick-validate

# 完整校验
./start-dev.sh validate

# 自动校验（启动时）
./start-dev.sh
```

## 输出示例

### fix-database.js 输出示例
```
🔧 开始修复数据库结构...
✅ 数据库连接成功
📋 当前data_sources表列: [id, name, type, connection_info, status, created_by, created_at, updated_at]
🔧 发现缺少description字段，正在添加...
✅ description字段添加成功
🔧 发现缺少last_test_at字段，正在添加...
✅ last_test_at字段添加成功
🔧 发现缺少last_sync_at字段，正在添加...
✅ last_sync_at字段添加成功
📋 修复后的data_sources表列: [id, name, type, connection_info, status, created_by, created_at, updated_at, description, last_test_at, last_sync_at]
✅ 数据库修复完成
```

### quick-validate.js 输出示例
```
🔍 快速系统校验...
✅ 数据库连接正常
✅ 表 data_sources 可访问
✅ 表 models 可访问
✅ 表 users 可访问
✅ data_sources.description 字段存在
✅ 快速校验完成
```

### validate-system.js 输出示例
```
🚀 开始系统一致性校验...
🔍 开始验证环境配置...
✅ 环境配置文件存在: ../backend/env.config.js
✅ 环境配置文件存在: ../frontend/env.config.js
✅ package.json存在: ../backend/package.json
✅ package.json存在: ../frontend/package.json
✅ 环境配置验证完成
🔍 开始验证数据库结构...
✅ 数据库连接成功
📋 表 data_sources 当前列: id, name, type, connection_info, status, created_by, created_at, updated_at, description, last_test_at, last_sync_at
✅ 数据库结构验证完成
🔍 开始验证后端API...
✅ 路由文件存在: src/routes/auth.js
✅ 路由文件存在: src/routes/dataSource.js
✅ 后端API验证完成
🔍 开始验证前端结构...
✅ 页面组件存在: src/pages/Dashboard.tsx
✅ 页面组件存在: src/pages/DataSourceManagement.tsx
✅ 前端结构验证完成

📊 系统一致性校验报告
==================================================
✅ 成功项目: 15
⚠️  警告项目: 0
❌ 错误项目: 0
🎉 系统一致性校验通过！
📄 详细报告已保存到: /path/to/validation-report.json
```

## 故障排除

### 常见错误及解决方案

#### 1. 依赖包缺失错误
```
Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'pg'
```
**解决方案**:
```bash
cd code/init-scripts
npm install pg
```

#### 2. 数据库连接失败
```
error: connect ECONNREFUSED 127.0.0.1:5432
```
**解决方案**:
- 检查PostgreSQL服务是否启动
- 验证数据库连接配置
- 确认端口号是否正确

#### 3. 权限错误
```
error: permission denied for table data_sources
```
**解决方案**:
- 检查数据库用户权限
- 确认用户有表的读写权限

#### 4. 表不存在错误
```
error: relation "data_sources" does not exist
```
**解决方案**:
- 运行数据库初始化脚本
- 检查表名拼写是否正确

### 调试技巧

1. **启用详细日志**:
```bash
DEBUG=* node validate-system.js
```

2. **检查配置文件**:
```bash
node -e "console.log(require('../backend/env.config.js'))"
```

3. **验证数据库连接**:
```bash
cd code/backend
node test-db-connection.js
```

## 相关文档

- [开发规范与校验规则](./开发规范与校验规则.md)
- [技术可行性分析](./技术可行性分析.md)
- [湖仓建模工具开发计划](./湖仓建模工具开发计划.md)
- [端口配置说明](./端口配置说明.md)

---

**注意**: 运行校验脚本前，请确保数据库服务正常运行，并且有足够的权限执行相关操作。
