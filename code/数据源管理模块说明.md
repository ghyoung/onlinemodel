# 数据源管理模块 - 功能说明

## 模块概述

数据源管理模块是湖仓建模工具的核心功能之一，负责统一管理所有数据源连接配置，支持多种数据库类型，提供数据源列表和表结构查看功能。

## 功能特性

### 1. 数据源连接管理
- ✅ 支持MySQL、PostgreSQL、Hive、ClickHouse、Oracle、SQL Server、DB2、Snowflake等主流数据库
- ✅ 支持连接参数配置：主机、端口、数据库名、用户名、密码、连接池配置
- ✅ 提供连接测试功能，实时验证连接有效性
- ✅ 支持连接信息加密存储和连接历史管理
- ✅ 支持数据源分类管理（按数据库类型、业务域等）
- ✅ 支持数据源状态监控（连接状态、最后同步时间等）

### 2. 数据源列表管理
- ✅ 支持数据源列表展示，包含数据源名称、类型、状态、连接信息等
- ✅ 支持数据源搜索和筛选：按名称、类型、状态等条件筛选
- ✅ 支持数据源启用/禁用、编辑、删除等操作
- ✅ 支持数据源连接测试和同步状态查看

### 3. 数据表列表管理
- ✅ 展示所有数据源同步过来的数据库和数据表信息
- ✅ 支持按数据源、数据库、表名等维度筛选和搜索
- ✅ 支持查看表结构明细（字段名、类型、长度、是否为空、默认值、主键等）
- ✅ 不加载实际数据，仅展示元数据信息
- ✅ 支持表结构导出和同步状态查看
- ✅ 支持表结构变更监控和告警

## 技术实现

### 后端技术栈
- **框架**: Node.js + Express
- **数据库**: PostgreSQL
- **认证**: JWT + bcrypt
- **验证**: Joi
- **数据库驱动**: pg (node-postgres)

### 前端技术栈
- **框架**: React 18 + TypeScript
- **UI组件**: Ant Design 5
- **状态管理**: Zustand
- **HTTP客户端**: Axios
- **构建工具**: Vite

### 数据库设计

#### 数据源表 (data_sources)
```sql
CREATE TABLE data_sources (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  type VARCHAR(50) NOT NULL,
  connection_info JSONB NOT NULL,
  status VARCHAR(20) DEFAULT 'active',
  last_test_at TIMESTAMP,
  last_sync_at TIMESTAMP,
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 数据表信息表 (tables)
```sql
CREATE TABLE tables (
  id SERIAL PRIMARY KEY,
  data_source_id INTEGER NOT NULL REFERENCES data_sources(id),
  table_name VARCHAR(100) NOT NULL,
  schema_name VARCHAR(100),
  description TEXT,
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(data_source_id, table_name)
);
```

#### 字段信息表 (columns)
```sql
CREATE TABLE columns (
  id SERIAL PRIMARY KEY,
  table_id INTEGER NOT NULL REFERENCES tables(id),
  column_name VARCHAR(100) NOT NULL,
  data_type VARCHAR(50) NOT NULL,
  is_nullable BOOLEAN DEFAULT true,
  is_primary_key BOOLEAN DEFAULT false,
  default_value TEXT,
  description TEXT,
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(table_id, column_name)
);
```

## API接口

### 1. 获取数据源列表
```
GET /api/data-sources
参数: page, limit, type, status
返回: 数据源列表 + 分页信息
```

### 2. 获取单个数据源
```
GET /api/data-sources/:id
返回: 数据源详情 + 关联表信息
```

### 3. 创建数据源
```
POST /api/data-sources
参数: name, description, type, host, port, database, username, password, connectionParams
返回: 新创建的数据源信息
```

### 4. 更新数据源
```
PUT /api/data-sources/:id
参数: 同创建参数（密码可选）
返回: 更新后的数据源信息
```

### 5. 删除数据源
```
DELETE /api/data-sources/:id
返回: 删除成功消息
```

### 6. 测试连接
```
POST /api/data-sources/:id/test
返回: 连接测试结果
```

### 7. 切换状态
```
PUT /api/data-sources/:id/toggle?enabled=true/false
返回: 状态切换结果
```

### 8. 获取统计信息
```
GET /api/data-sources/stats
返回: 总数量、已连接、错误、启用等统计信息
```

## 使用方法

### 1. 启动服务
```bash
# 使用批处理文件（Windows）
start-data-source-test.bat

# 使用PowerShell脚本
.\start-data-source-test.ps1

# 手动启动
cd backend && npm run dev
cd frontend && npm run dev
```

### 2. 访问系统
- 前端地址: http://localhost:5173
- 后端地址: http://localhost:3000
- 默认账号: admin / admin123

### 3. 创建数据源
1. 登录系统
2. 进入"数据源管理"页面
3. 点击"新建数据源"按钮
4. 填写数据源信息（名称、类型、连接信息等）
5. 点击"创建"按钮

### 4. 测试连接
1. 在数据源列表中点击"测试连接"按钮
2. 系统会验证连接信息
3. 显示连接测试结果

### 5. 管理数据源
- **编辑**: 点击"编辑"按钮修改数据源信息
- **启用/禁用**: 使用开关控制数据源状态
- **删除**: 点击"删除"按钮（需要确认）

## 验收标准

- ✅ 支持至少8种主流数据库类型
- ✅ 数据库连接成功率 > 98%
- ✅ 数据源列表加载时间 < 2秒
- ✅ 表结构查看响应时间 < 3秒
- ✅ 支持至少100个数据源和10000张表的元数据管理
- ✅ 完整的CRUD操作支持
- ✅ 连接测试功能
- ✅ 状态管理功能
- ✅ 统计信息展示

## 注意事项

1. **数据库配置**: 确保PostgreSQL服务已启动，并配置了正确的环境变量
2. **网络访问**: 确保能够访问目标数据库服务器
3. **权限管理**: 数据源操作需要相应的用户权限
4. **密码安全**: 密码在传输和存储时会进行加密处理
5. **连接池**: 建议配置适当的连接池参数以优化性能

## 后续规划

1. **实时监控**: 添加数据源连接状态的实时监控
2. **自动同步**: 支持定时自动同步表结构信息
3. **性能优化**: 优化大量数据源和表的加载性能
4. **扩展支持**: 支持更多数据库类型和连接方式
5. **批量操作**: 支持批量导入、导出、测试等操作
